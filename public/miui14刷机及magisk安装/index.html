<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>MIUI 14刷机及Magisk安装 - CRuffians</title><meta name="author" content="Francis Fu">
<meta name="author-link" content="https://francisfu.com/">
<meta name="description" content="这两天休息在家，研究了一下小米MIUI 14刷机的方式，主要是结合Magisk模块安装和后续的一系列操作，在此作一简单记录。" /><meta name="keywords" content='Hugo, FixIt' /><meta itemprop="name" content="MIUI 14刷机及Magisk安装">
<meta itemprop="description" content="这两天休息在家，研究了一下小米MIUI 14刷机的方式，主要是结合Magisk模块安装和后续的一系列操作，在此作一简单记录。"><meta itemprop="datePublished" content="2023-04-24T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-04-24T00:00:00+00:00" />
<meta itemprop="wordCount" content="7801"><meta itemprop="image" content="https://francisfu.com/icon.png"/>
<meta itemprop="keywords" content="" /><meta property="og:title" content="MIUI 14刷机及Magisk安装" />
<meta property="og:description" content="这两天休息在家，研究了一下小米MIUI 14刷机的方式，主要是结合Magisk模块安装和后续的一系列操作，在此作一简单记录。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://francisfu.com/miui14%E5%88%B7%E6%9C%BA%E5%8F%8Amagisk%E5%AE%89%E8%A3%85/" /><meta property="og:image" content="https://francisfu.com/icon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-04-24T00:00:00+00:00" /><meta property="og:site_name" content="CRuffians" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://francisfu.com/icon.png"/>

<meta name="twitter:title" content="MIUI 14刷机及Magisk安装"/>
<meta name="twitter:description" content="这两天休息在家，研究了一下小米MIUI 14刷机的方式，主要是结合Magisk模块安装和后续的一系列操作，在此作一简单记录。"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://francisfu.com/miui14%E5%88%B7%E6%9C%BA%E5%8F%8Amagisk%E5%AE%89%E8%A3%85/" /><link rel="prev" href="https://francisfu.com/ai%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%88%91%E8%A7%81/" /><link rel="next" href="https://francisfu.com/ai%E6%9D%BF%E5%9D%97%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "MIUI 14刷机及Magisk安装",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/francisfu.com\/miui14%E5%88%B7%E6%9C%BA%E5%8F%8Amagisk%E5%AE%89%E8%A3%85\/"
    },"genre": "posts","wordcount":  7801 ,
    "url": "https:\/\/francisfu.com\/miui14%E5%88%B7%E6%9C%BA%E5%8F%8Amagisk%E5%AE%89%E8%A3%85\/","datePublished": "2023-04-24T00:00:00+00:00","dateModified": "2023-04-24T00:00:00+00:00","license": "Francis Fu © All Rights Reserved","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Francis Fu"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="CRuffians"><span class="header-title-text">CRuffians</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item has-children">
              <a
                class="menu-link"
                href="/"
                
                
              >AI</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i>
                <ul class="sub-menu">
                  <li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://gpt.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >ChatGPT</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://cgs.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >Prompts</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://peg.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >PE Guide</a>
                      </li></ul></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="CRuffians"><span class="header-title-text">CRuffians</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><span class="nested-item">
                  <a
                    class="menu-link"
                    href="/"
                    
                    
                  >AI</a>
                  <i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden="true"></i>
                </span>
                <ul class="sub-menu">
                  <li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://gpt.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >ChatGPT</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://cgs.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >Prompts</a>
                      </li><li
                        class="menu-item"
                      >
                        <a
                          class="menu-link"
                          href="https://peg.francisfu.com"
                          
                          rel="noopener noreferrer" target="_blank"
                        >PE Guide</a>
                      </li></ul></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>MIUI 14刷机及Magisk安装</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://francisfu.com/" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
    Francis Fu</a></span>
          <span class="post-category">收录于 <a href="/categories/%E5%AE%89%E5%8D%93%E9%82%A3%E7%82%B9%E4%BA%8B%E5%84%BF/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 安卓那点事儿</a></span></div>
      <div class="post-meta-line"><span title="发布于 2023-04-24 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-24">2023-04-24</time></span>&nbsp;<span title="更新于 2023-04-24 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-24">2023-04-24</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 7801 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 16 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0理论铺垫">0.理论铺垫</a></li>
    <li><a href="#1准备工作">1.准备工作</a></li>
    <li><a href="#2手机解锁">2.手机解锁</a></li>
    <li><a href="#3提取引导文件">3.提取引导文件</a></li>
    <li><a href="#4安装magisk">4.安装Magisk</a></li>
    <li><a href="#5文件管理">5.文件管理</a></li>
    <li><a href="#6神隐土遁">6.神隐土遁</a>
      <ul>
        <li><a href="#61-zygisk">6.1 Zygisk</a></li>
        <li><a href="#62-隐藏magisk">6.2 隐藏Magisk</a></li>
        <li><a href="#63-shamiko">6.3 Shamiko</a></li>
      </ul>
    </li>
    <li><a href="#7-外挂插件">7. 外挂插件</a></li>
    <li><a href="#8transparent-proxy">8.Transparent Proxy</a></li>
    <li><a href="#9结语">9.结语</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>这两天休息在家，研究了一下小米MIUI 14刷机的方式，主要是结合Magisk模块安装和后续的一系列操作，在此作一简单记录。</p>
<p>两年前我写了一篇魔趣ROM的刷机教程。两年后，「斯人已逝」，魔趣ROM官方停止了更新。国产第三方ROM的时代一去不返了，此后只能研究折腾官方ROM了。而夹带私货的官方ROM，无论选哪个，都是吃屎一般的感觉，只不过某些屎相比其他的，可能还稍微容易让人下咽一些。本文的环境是：<strong>小米11，MIUI 14.0.8.0</strong>。在工作开始之前，需要先了解一个概念：Virtual A/B Partition。</p>
<div class="details admonition warning open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><em>如果在操作过程中遇到无法下载的情况，请考虑网络因素。</em></div>
    </div>
  </div>
<h2 id="0理论铺垫">0.理论铺垫</h2>
<p>安卓系统为智能手机的普及立下了汗马功劳，可是开源所导致的碎片化问题，一直是谷歌心中难以掩饰的痛。为了改变这一现状，谷歌进行了许多尝试，例如在An­droid 7.0引入的「A/​B 无缝系统更新」，An­droid 8.0时推出的「Pro­ject Tre­ble」，都是为了铺平无障碍更新系统的道路，减轻更新失败导致设备故障的风险，以便厂商可以更轻松地推送系统更新。</p>
<p>而在Android 11版本，谷歌使用了名为「vir­tual A/​B」的新分区，并将其率先使用在Pixel 5 上。「vir­tual A/​B」更新系统的方法与「A/​B」类似，核心功能也相同。在系统进行OTA更新时，如果更新失败，则会自动回滚到上一个系统，成功开机进入之后才会将新数据写入到系统中。且系统更新可在待机状态下完成，无需重启等待新数据写入，可谓是极大地改善了更新系统时的用户体验。只是「A/​B」需要准备两个相同的分区，会占用更多的存储空间，而「vir­tual A/​B」删除了「cache」和「re­cov­ery」分区，「sys­tem」分区只保留一个，以解决上述空间占用问题。</p>
<p>小米11也是使用的「vir­tual A/​B」的机型，这对玩家而言并不是什么好消息。因为「vir­tual A/​B」删除了「re­cov­ery」分区，没有了「re­cov­ery」分区就不能刷入第三方「re­cov­ery」。因此在 TWRP 官方解决为这类新分区方式刷入第三方 re­cov­ery 之前，我们只能使用其他方法来为诸如小米11的使用Virtual A/B分区手机进行刷机了。</p>
<p>当然本文的目的只是安装Magisk模块，相比于完整刷机，简单很多，风险也小不少。</p>
<p>Magisk是什么？百度给出的解释是：Magisk是一套用于定制Android的开源工具,支持高于 Android4.2的设备。涵盖了Android定制的基本部分:root、引导脚本、SELInux修补、移除AVB2.0/dm-verity/强制加密等。它是当前Android社区用来获取root权限的主流方式。同时，Magisk特殊的运作机制还赋予了它systemless的特质。systemless让Magisk一方面可以有针对性地隐藏root，甚至暂时隐藏Magisk本身。另一方面，挂载系统的存在，也让Magisk拥有了多样的模块化生态系统。</p>
<p>在玩家群体里，Magisk被称为「面具」，基本是「搞机达人」人手必备的强大工具。有了它，就可以轻松获取root权限，挂载强大的功能模块。</p>
<h2 id="1准备工作">1.准备工作</h2>
<p>刷机之前，请务必备份手机里所有重要的个人数据，包括但不限于：通讯录、照片、应用数据等。刷机过程中会清除全部个人数据，所以一定一定做好备份！</p>
<h2 id="2手机解锁">2.手机解锁</h2>
<p>现在不少手机是锁BootLoader的，BootLoader对于嵌入式设备（如ARM架构）而言类似于PC设备的BIOS。出于对设备安全性的考虑，厂商会锁定BootLoader以防止恶意程序或者不法分子篡改。那么如果我们要更换操作系统，第一步就是需要解锁BootLoader。很多国产手机厂商已经不支持解锁BL了，不过小米截至目前都是允许的。小米手机的解锁请参考<a href="http://www.miui.com/unlock/download.html"target="_blank" rel="external nofollow noopener noreferrer">这个页面</a>，先下载手机解锁程序到电脑上，解压缩后，依次执行如下步骤：</p>
<ol>
<li>在电脑上打开小米手机解锁程序（miflash_unlock.exe）；</li>
<li>同意条款，登录小米账户，进入待解锁界面；</li>
<li>拿出手机，进入「设置 -&gt; 我的设备 -&gt; 全部参数」页面；</li>
<li>这时连续点击MIUI版本号7次；</li>
<li>直到手机屏幕提示已经处于开发者模式即可停止点击；</li>
<li>进入「设置 -&gt; 更多设置 -&gt; 开发者选项 -&gt; 设备解锁状态」中按照提示绑定账号和设备，新机可能需要连续绑定账号7天才能继续进行操作；</li>
<li>手动进入Bootloader模式（先关机，然后同时按住开机键和音量下键，直到手机界面出现米兔画面和FASTBOOT字样）；</li>
<li>通过USB将电脑连接手机，点击程序上的「解锁」按钮。
解锁过程中根据电脑情况可能会自动安装小米手机驱动，并且联网验证当前手机，所以需要保持电脑和手机的联网状态。另外，根据机型不同，程序会提示解锁操作是否会清空全部用户数据，请注意备份数据。<br>
解锁后手机会自动重启，如果解锁成功，在启动界面下方会出现一把打开的小锁头图标和「unlocked」字样。此时标志着解锁成功。</li>
</ol>
<h2 id="3提取引导文件">3.提取引导文件</h2>
<p>Magisk模块的刷入需要通过修补系统引导文件「boot.img」的方式去完成，所以我们需要下载对应系统版本的线刷包，然后提取引导文件。小米的ROM可以在<a href="https://miuirom.org/"target="_blank" rel="external nofollow noopener noreferrer">这个网址</a>找到。搜索「mi 11」关键字后，找到对应的手机型号和系统版本，我使用的是国行14.0.8.0ROM，对应的在网站上名称是「MIUI China 14.0.8.0.TKBCNXM」。在下载链接处可以看到两个链接，分别是「Recovery」和「Fastboot」，前者是卡刷包，后者是线刷包。我们这里下载线刷包。下载好的文件解压缩后即可在根目录下找到boot.img文件，将他复制到手机中去。</p>
<h2 id="4安装magisk">4.安装Magisk</h2>
<p>首先<a href="https://github.com/topjohnwu/Magisk/releases"target="_blank" rel="external nofollow noopener noreferrer">在此处</a>下载Magisk Man­ager安装并打开，目前最新版是v26.1。打开后右上角有一个「安装」，点击「选择并修补一个文件」，从文件管理器中选择刚才复制过来的boot.img文件。Magisk会自动修补它，并将修补好的文件放在 /Download 目录下，名为「magisk_patched_xxxxx.img」。将这个修补好的文件复制到电脑，为下一步刷入做准备。</p>
<p>在本文<cite>附件<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></cite>中下载ADB工具箱并解压到电脑中，连接手机到电脑，在「开发者选项」中打开手机的「USB调试」功能。双击工具箱中的「打开CMD命令行.bat」，依次输入下述命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">adb devices
</span></span></code></pre></td></tr></table>
</div>
</div><p>该命令会成功列出当前adb设备，如果失败的话，可以检查驱动、数据线、电脑接口等，进行一一排查。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">adb reboot bootloader
</span></span></code></pre></td></tr></table>
</div>
</div><p>该命令会将手机重启到Fast­boot模式，然后就可以刷入打过补丁的boot.img了。由于修补过后的 magisk_patched_xxxxx.img名字每次都不一样，建议重命名为「magisk_patched.img」。由于是Virtual A/B分区方案，必须将两个分区中的引导文件全部修补才可以避免变砖。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">fastboot flash boot_a magisk_patched.img
</span></span><span class="line"><span class="cl">fastboot flash boot_b magisk_patched.img
</span></span></code></pre></td></tr></table>
</div>
</div><p>刷入成功后，输入<code>fastboot reboot</code>命令重启手机，不出意外的话，再次打开Magisk就可以看到已经成功的激活了。</p>
<h2 id="5文件管理">5.文件管理</h2>
<p>root手机以后，我们需要在<a href="https://rootexplorer.co/"target="_blank" rel="external nofollow noopener noreferrer">这个链接</a>下载Root Explorer，也就是大名鼎鼎的RE文件管理器。再获取root权限后，它可以浏览整个手机的文件系统，为后续编辑系统核心目录文件做好铺垫。下载下来的是安卓apk程序包，直接打开安装即可。</p>
<p>安装好启动程序，在Magisk中可以看到它索取root权限，点击授权，即可正常访问所有目录。可以尝试访问 /data/adb 目录做测试，后续我们也会主要用到这个目录。</p>
<h2 id="6神隐土遁">6.神隐土遁</h2>
<p>由于Magisk模块是一种root的手段，如果不加以隐藏，将导致很多金融类APP和游戏类APP无法正常使用。金融类比如微信支付、支付宝、各种银行官方APP等，主要是基于防止资金被盗的考虑。游戏类比如王者荣耀、英雄联盟等，主要是基于防止外挂的考虑。这个时候就需要隐藏Magisk和root权限。首先是安装我们所需要的两个模块：自动神仙救砖、Shamiko和LSPosed。</p>
<p>「自动神仙救砖」模块是玩Magisk必刷的模块，而且是要第一个刷的。它可以在出现模块冲突导致死机变砖时，自动禁用所有模块并重启进入系统。类似于Windows的「安全模式」。由于是2021年发布于论坛的，官方链接已经早不可考，可以在<cite>附件<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></cite>中下载。Magisk模块都是压缩包，下载后复制到手机上，从软件内部选择并安装即可。</p>
<p>「Shamiko」和「LSPosed」模块都可以在<a href="https://lsposed.org/"target="_blank" rel="external nofollow noopener noreferrer">这个链接</a>找到。在安装这两个模块之前，首先要在Magisk中开启Zygisk选项。这里需要插播一条理论介绍，关于什么是Zygisk。</p>
<h3 id="61-zygisk">6.1 Zygisk</h3>
<p>Zygisk和曾经非常主流，但是现在已经被废弃的Riru一样，都是Zygote注入工具。那么Zygote是什么？在安卓中，负责孵化新进程的父进程叫做Zygote，安卓上的应用进程都是由Zygote进程孵化的。众所周知，安卓是Linux内核，安卓系统上运行的一切程序都是放在Dalvik虚拟机上的，Zygote也不例外。事实上，它是安卓系统运行的第一个Dalvik虚拟机进程，是由Linux内核启动的用户级进程Init所创建的。</p>
<p>那么Zygisk和Riru区别在哪？Riru是Magisk老版本内置的Zygote注入器，配合Magisk Hide功能，可以完美的将Magisk隐藏到Zygote进程中，防止被子级进程发现Magisk的存在。但是由于Magisk的核心开发者被谷歌「招安」，承诺不再提供隐蔽Magisk功能，Magisk Hide功能就被从v24版本中移除了。与之不同的是，Zygisk能为Magisk模块提供更深入、更强悍的核心修改能力。它有一个排除列表，可以撤销Magisk及模块所产生的所有更改。这样用户就能手动划定Magisk起作用的范围。但是，该功能跟Riru不同，不能避免root被检测到，没有任何隐藏作用。即使将某些程序加入排除列表，它们依旧可以发现Zygisk/Magisk的存在，只是模块对其无法生效而已。如果用户要隐藏root，只能借助其他方式，比如Shamiko。此外，Zygisk和Riru是无法共存的，当前版本Magisk中自带Zygisk，而且也是未来一段时间的主流Zygote注入解决方案。</p>
<p>启用Zygisk比较简单，打开Magisk，点击右上角的「设置」图标，选择「Zygisk」开关，打开它。重启手机后设置会生效。</p>
<h3 id="62-隐藏magisk">6.2 隐藏Magisk</h3>
<p>继续点击Magisk设置，找到「隐藏 Magisk 应用」选项，启用它，会弹出一个已经有默认名称「Settings」的对话框，此处可以随意输入想要伪装的名字。比如我们输入Yamato，一路点击确定后，会在桌面出现新生成的APP名为Yamato。这个APP没有图标，打开它会跳转至Magisk程序，并询问你是否创建一个容易识别的快捷方式。如果有需求，可以在桌面创建一个快捷方式。</p>
<h3 id="63-shamiko">6.3 Shamiko</h3>
<p>完成隐藏Magisk并启用Zygisk后，我们就可以刷入Shamiko模块了。它的作用很简单，就是隐藏root。成功刷入并重启手机后，Shamiko模块会提示一个笑脸，并显示「Shamiko is working as blacklist mode」。这里需要指出，Shamiko默认工作在黑名单模式下，即对选定的APP隐藏root，未选定的一律不隐藏。黑名单的设置在Magisk设置中的「配置排除列表」中进行选定。需要注意的是，如果想要完整的屏蔽一个APP，必须<strong>全部勾选</strong>该APP的所有子进程，否则无法实现完全屏蔽。</p>
<p>不过，由于我手机中大部分程序是需要屏蔽的，我只对ADB调试程序和Root Explorer文件管理器开放root权限，所以白名单模式会更加适合我。白名单模式是，只对已经在Magisk中获取了root权限的程序（即「超级用户」列表下已经显示的程序）开放root权限，其余程序一律屏蔽。实际上，出于安全考虑，我个人也建议使用白名单模式。但是据称，白名单模式可能存在严重的性能和内存占用问题。具体使用哪一种模式，还需要用户自行体验感受。</p>
<p>切换白名单模式也很简单，打开RE浏览器，在 /data/adb/shamiko 目录下建立一个空的新文件，文件名为「whitelist」，无需重启即可切换Shamiko为白名单模式。回到Magisk中就可以看到Shamiko已经工作在白名单模式下了。白名单模式默认禁止授权新的root权限，如果有新的需要赋予root权限的APP，删除这个文件切回黑名单模式，赋予权限后再重建即可。</p>
<h2 id="7-外挂插件">7. 外挂插件</h2>
<p>说到外挂功能模块，那自然是要讨论LSPosed。这里还是要插播一条理论介绍，什么是LSPosed，它跟XPosed区别又在哪里？</p>
<p>根据百度，我们可以知道，XPosed框架(Xposed Framework)是一套开源的、在Android高权限模式下运行的框架服务，可以在不修改APK文件的情况下影响程序运行（修改系统）的框架服务，基于它可以制作出许多功能强大的模块，且在功能不冲突的情况下同时运作。换句话说，由于XPosed运行在root权限下，对于运行在常规权限下的其他APP来说，自然是降维打击。它为各种第三方插件的代码提供了一个高权限的容器，可以基于XPosed框架开发各种功能强大的插件。我们听说过或者使用过的一些微信自动抢红包、防撤回等插件，就都是运行在XPosed框架内的知名插件。</p>
<p>自原版Xposed框架为安卓平台的注入提供了统一规范以来，安卓搞机进入了一个全新的时代。而在时间变迁中，原版Xposed开发停止，新的框架逐渐接替其位置。EdXposed框架在高版本安卓上几乎完全取代了原版Xposed的地位。今天要说的LSPosed（又名「老色批」），则是基于EdXposed开发的半个新框架，它的出现主要由于EdXposed存在的以下现状：</p>
<ol>
<li>EdXposed的主要维护者solohsu是一只老鸽子，喜欢咕咕咕，长期没有更新代码。</li>
<li>EdXposed在MlgmXyysd的主导下，倾向于保持与原版Xposed框架的兼容性和行为一致性，存在大量历史包袱。</li>
<li>EdXposed管理器没有很好地适应当前Xposed界的发展情况，允许用户进行一些可能给手机带来卡顿的操作。</li>
</ol>
<p>LSPoesd针对这些问题作出了改进：1.拿出砍刀大砍特砍，无用的功能与代码统统砍掉，更精简的代码意味着更佳的性能表现。2.去掉了全局模式与黑白名单机制。在使用LSPosed时，必须针对各个插件选择该插件将会注入的应用，也就是其“作用域”。这样虽然引入了额外的操作，但有效防止了过多无用的注入引起的卡顿问题或隐私问题。换言之，LSPosed并未在原理上进行大的调整，重点在于引导用户「正确合法」地使用Xposed框架，确保Xposed框架和插件都不会做多余的事。同时，LSPosed还引入了新的Xposed API，允许插件自动告知管理器它所需要的作用域，无需手动设置。3.管理器不再作为单独app，成为SystemUI的一部分并通过拨号或者快捷方式启动。4.加入native层注入的支持（旧版Xposed模块通常只支持Java层注入）5.维护全新的Xposed模块仓库，取代XDA所维护的那个年久失修的仓库。</p>
<p>鉴于有如此多的优点和好处，我们自然要选择LSPosed框架。刷入Magisk并重启手机后，LSPosed即开始正常工作了。如果建立了桌面快捷方式，可以看到它是一个蓝色的X形创可贴。如果不小心忘记了建立，也可以在拨号界面输入「*#*#5776733#*#*」（即LSPOSED的九键数字）唤出LSPosed主界面。</p>
<p>LSPosed下，我最需要安装的是这个插件：<a href="https://github.com/MinaMichita/AntiAntiDefraud/releases"target="_blank" rel="external nofollow noopener noreferrer">AntiAntiDefraud</a>。自从MIUI 14后，小米在系统中加入了反诈模块，自动扫描手机中安装的软件包并上传至广东机房，同时将副本上传至腾讯天御安防系统。我个人非常反感这种泄露隐私的行为。MIUI届的大佬「MinaMichita」开发了这款XPosed插件，屏蔽上传链接，阻止列表上传。下载APK文件并安装后，在LSPosed中授权启用插件即可正常使用，日志中可以查看屏蔽器是否生效，具体可以参考Github上Readme文档中的说明。</p>
<h2 id="8transparent-proxy">8.Transparent Proxy</h2>
<div class="details admonition warning open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><em>此章节为高级用法，非专业人士请勿尝试。</em></div>
    </div>
  </div>
<p>This is the most important part of the whole article, about how to set up a transparent proxy with Magisk. While using proxies or VPNs, you may face some problems, like, you have to install some apks, or a VPN connection may show up in the notification bar and leave a record in your phone. This may cause great influence, you know what I mean. A transparent proxy is, as it&rsquo;s name, a proxy that no one can see, and will left almost nothing in your phone. I will show you how to do so.</p>
<p>First, download the Magisk module <a href="https://github.com/CHIZI-0618/box4magisk/releases"target="_blank" rel="external nofollow noopener noreferrer">box4magisk</a>. I use the latest version (v4.6). Install the module in the Magisk.</p>
<p>The module support mutiple core of 3rd generation proxies, such as: clash, clash.meta, sing-box, v2ray-core and Xray-core. Here I choose to use Clash. Then we need to download clash-core from <a href="https://github.com/Dreamacro/clash/releases/tag/premium"target="_blank" rel="external nofollow noopener noreferrer">this link</a>. I choose the Premium version(clash-linux-armv7-2023.04.16.gz), which will support more functions. Unzip the file, extract the clash core and rename it into &ldquo;clash&rdquo;, copy it into the phone and place it under /data/adb/box/bin/ .</p>
<p>Now you have to set up the proxy config file. I tried a lot here, the default version of config.yaml under clash folder have multiple bugs. Here is an example of config.yaml file content under the clash folder:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">mixed-port</span><span class="p">:</span><span class="w"> </span><span class="m">7890</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">redir-port</span><span class="p">:</span><span class="w"> </span><span class="m">7891</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tproxy-port</span><span class="p">:</span><span class="w"> </span><span class="m">1536</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">allow-lan</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">geodata-mode</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">unified-delay</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">log-level</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ipv6</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">external-controller</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">9999</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#external-ui: dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">enable-process</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">find-process-mode</span><span class="p">:</span><span class="w"> </span><span class="l">strict</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#tcp-concurrent: true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">global-client-fingerprint</span><span class="p">:</span><span class="w"> </span><span class="l">chrome</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">geox-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">geoip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.dat&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">geosite</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mmdb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country.mmdb&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">profile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">store-selected</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">store-fake-ip</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">sniffer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sniff</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TLS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">443</span><span class="p">,</span><span class="w"> </span><span class="m">8443</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HTTP</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">80</span><span class="p">,</span><span class="w"> </span><span class="m">8080-8880</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">override-destination</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tun</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l">tun3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">stack</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">inet6-address</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dns-hijack</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s1">&#39;any:53&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">auto-route</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">auto-detect-interface</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">1053</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipv6</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enhanced-mode</span><span class="p">:</span><span class="w"> </span><span class="l">fake-ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">fake-ip-range</span><span class="p">:</span><span class="w"> </span><span class="m">28.0.0.1</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">default-nameserver</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">223.5.5.5</span><span class="p">,</span><span class="w"> </span><span class="m">119.29.29.29</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nameserver</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;https://doh.pub/dns-query&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;https://dns.alidns.com/dns-query&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">fallback</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;https://doh.dns.sb/dns-query&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;https://dns.cloudflare.com/dns-query&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;https://dns.twnic.tw/dns-query&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tls://8.8.4.4:853&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">fallback-filter</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">geoip: true, ipcidr</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">240.0.0.0</span><span class="l">/4, 0.0.0.0/32] }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">proxies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="cp">&amp;p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>{<span class="nt">type: http, interval: 3600, health-check</span><span class="p">:</span><span class="w"> </span>{<span class="nt">enable: true, url: https://www.gstatic.com/generate_204, interval</span><span class="p">:</span><span class="w"> </span><span class="m">300</span>}}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">pr</span><span class="p">:</span><span class="w"> </span><span class="cp">&amp;pr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>{<span class="nt">type: select, proxies</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">PROXY, AUTO, DIRECT]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">u</span><span class="p">:</span><span class="w"> </span><span class="cp">&amp;u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">use</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">provider1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># - provider2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">proxy-providers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="cp">*p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># url: &#34;provider1 订阅链接&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./proxy_providers/provider1.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># provider2:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   &lt;&lt;: *p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   url: &#34;provider2 订阅链接&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   path: ./proxy_providers/provider2.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">proxy-groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: PROXY, &lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="cp">*u}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- {<span class="nt">name: AUTO, &lt;&lt;: *u, tolerance: 2, type</span><span class="p">:</span><span class="w"> </span><span class="l">url-test}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rule-providers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">reject</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/reject.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">google</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/google.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">proxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/proxy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">direct</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/direct.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">private</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/private.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gfw</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/gfw.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tld-not-cn</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/tld-not-cn.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">telegramcidr</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">ipcidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/telegramcidr.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cncidr</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">ipcidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/cncidr.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lancidr</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">ipcidr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/lancidr.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">applications</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">behavior</span><span class="p">:</span><span class="w"> </span><span class="l">classical</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">./ruleset/applications.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="m">86400</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">DOMAIN-SUFFIX,services.googleapis.cn,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">DOMAIN-SUFFIX,googleapis.cn,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">DOMAIN-SUFFIX,xn--ngstr-lra8j.com,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,applications,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">DOMAIN,clash.razord.top,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">DOMAIN,yacd.haishan.me,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,private,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,reject,REJECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,google,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,proxy,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,direct,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,lancidr,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,cncidr,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">RULE-SET,telegramcidr,PROXY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">GEOIP,LAN,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">GEOIP,CN,DIRECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">MATCH,PROXY</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And you should set up a &ldquo;provider1.yaml&rdquo; file under /proxy_providers folder in the same directory, which contains all the proxies of this provider:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">proxies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {<span class="w"> </span><span class="l">your proxy one }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {<span class="w"> </span><span class="l">your proxy two }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The final thing is to edit the file /data/adb/box/scripts/box.config . This file controls how module work. Commonly there are three ways: Blacklist, whitelist and all. By default, the module will work under &ldquo;all&rdquo; mode, which will tunnel all traffic from the phone to the proxy. However, if you want to tunnel some specific traffic only, use whitelist mode. Otherwise, if you want to un-tunnel some specific traffic, use blacklist mode. Like the Shamiko module, I only want to tunnel some specific traffic only, so I choose to use whitelist mode. Here is an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/system/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">bin_name</span><span class="o">=</span><span class="s2">&#34;clash&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">redir_port</span><span class="o">=</span><span class="s2">&#34;7891&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">tproxy_port</span><span class="o">=</span><span class="s2">&#34;1536&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">clash_dns_port</span><span class="o">=</span><span class="s2">&#34;1053&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">clash_dns_listen</span><span class="o">=</span><span class="s2">&#34;0.0.0.0:</span><span class="si">${</span><span class="nv">clash_dns_port</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">clash_fake_ip_range</span><span class="o">=</span><span class="s2">&#34;28.0.0.1/8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">tun_device</span><span class="o">=</span><span class="s2">&#34;tun0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">box_user_group</span><span class="o">=</span><span class="s2">&#34;root:net_admin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you want to change the user or group, you must make the Box core in the /system/bin directory, otherwise the changes will not take effect.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you are using Magisk, you can copy the Box core files (sing-box, clash, etc.) to /data/adb/modules/bin_files/system/bin/ and reboot the phone</span>
</span></span><span class="line"><span class="cl"><span class="nv">bin_name_list</span><span class="o">=(</span><span class="s2">&#34;sing-box&#34;</span> <span class="s2">&#34;clash&#34;</span> <span class="s2">&#34;xray&#34;</span> <span class="s2">&#34;v2ray&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">box_path</span><span class="o">=</span><span class="s2">&#34;/data/adb/box&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">bin_path</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">box_path</span><span class="si">}</span><span class="s2">/bin/</span><span class="si">${</span><span class="nv">bin_name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">run_path</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">box_path</span><span class="si">}</span><span class="s2">/run&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">pid_file</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">run_path</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">bin_name</span><span class="si">}</span><span class="s2">.pid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">intranet</span><span class="o">=(</span>0.0.0.0/8 10.0.0.0/8 100.64.0.0/10 127.0.0.0/8 169.254.0.0/16 192.0.0.0/24 192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.51.100.0/24 203.0.113.0/24 224.0.0.0/4 240.0.0.0/4 255.255.255.255/32<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">intranet6</span><span class="o">=(</span>::/128 ::1/128 ::ffff:0:0/96 100::/64 64:ff9b::/96 2001::/32 2001:10::/28 2001:20::/28 2001:db8::/32 2002::/16 fe80::/10 ff00::/8<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ipv6</span><span class="o">=</span><span class="s2">&#34;disable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">proxy_method</span><span class="o">=</span><span class="s2">&#34;TPROXY&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># REDIRECT: TCP only / TPROXY: TCP + UDP / MIXED: REDIRECT TCP + TUN UDP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">proxy_mode</span><span class="o">=</span><span class="s2">&#34;whitelist&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># blacklist / whitelist / core</span>
</span></span><span class="line"><span class="cl"><span class="nv">user_packages_list</span><span class="o">=(</span><span class="s2">&#34;0:com.google.android.gsf&#34;</span> <span class="s2">&#34;0:com.google.android.onetimeinitializer&#34;</span> <span class="s2">&#34;0:com.google.android.gms&#34;</span> <span class="s2">&#34;0:com.android.vending&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Android User:Package Name, For example:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># user_packages_list=(&#34;0:com.android.captiveportallogin&#34; &#34;10:com.tencent.mm&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ap_list</span><span class="o">=(</span><span class="s2">&#34;wlan+&#34;</span> <span class="s2">&#34;ap+&#34;</span> <span class="s2">&#34;rndis+&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">ignore_out_list</span><span class="o">=()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice the line of &ldquo;proxy_mode&rdquo; and &ldquo;user_packages_list&rdquo;. In this file, I proxied all the Google series app&rsquo;s traffic. You can add more apps in the same format: &ldquo;user-id:package-name&rdquo;.</p>
<p>Therefore, when you finished all three config files, place them into the right place, restart the module, you can see from the log at /data/adb/box/run and check if your proxy works great.</p>
<h2 id="9结语">9.结语</h2>
<p>至此，小米11/MIUI 14刷机过程就全部结束了。希望国产ROM能有健康的发展，也期待有一天网络环境可以越来越好，个人隐私可以越来越安全。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>附件 &ndash; <a href="https://cloudreve.francisfu.net:16666/s/13HX"target="_blank" rel="external nofollow noopener noreferrer">MIUI刷机工具箱</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-04-24 00:00:00">更新于 2023-04-24&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/miui14%E5%88%B7%E6%9C%BA%E5%8F%8Amagisk%E5%AE%89%E8%A3%85/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/ai%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%88%91%E8%A7%81/" class="post-nav-item" rel="prev" title="AI技术之我见"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>AI技术之我见</a>
      <a href="/ai%E6%9D%BF%E5%9D%97%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" class="post-nav-item" rel="next" title="AI板块使用说明">AI板块使用说明<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.111.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://francisfu.com/"target="_blank" rel="external nofollow noopener noreferrer">Francis Fu</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/js/_custom.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":50},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
